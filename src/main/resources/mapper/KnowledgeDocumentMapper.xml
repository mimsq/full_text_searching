<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.serching.fulltextsearching.mapper.KnowledgeDocumentMapper">

    <!-- 根据知识库ID分页查询文档 -->
    <select id="selectByKbId" resultType="com.serching.fulltextsearching.entity.KnowledgeDocument">
        SELECT * FROM t_knowledge_document
        WHERE kb_id = #{knowledgeBaseId}
        ORDER BY category_id, id
        LIMIT #{pageNum}, #{pageSize}
    </select>

    <!-- 最近编辑文档列表（按最后一次编辑时间倒序，去重文档） -->
    <select id="selectRecentEdited" resultType="com.serching.fulltextsearching.entity.KnowledgeDocument">
        SELECT d.*
        FROM t_operation_log ol
        JOIN t_knowledge_document d ON d.id = ol.object_id
        WHERE ol.operation_type = 2
          AND (ol.object_type IS NULL OR ol.object_type = 'document')
          AND d.del_status = 0
          AND d.doc_status = 1
          <if test="kbId != null">
            AND ol.kb_id = #{kbId}
          </if>
          <if test="userId != null">
            AND ol.created_by = #{userId}
          </if>
        GROUP BY d.id
        ORDER BY MAX(ol.created_at) DESC
        LIMIT #{pageNum}, #{pageSize}
    </select>

    <!-- 最近编辑文档总数（去重） -->
    <select id="countRecentEdited" resultType="long">
        SELECT COUNT(DISTINCT ol.object_id)
        FROM t_operation_log ol
        JOIN t_knowledge_document d ON d.id = ol.object_id
        WHERE ol.operation_type = 2
          AND (ol.object_type IS NULL OR ol.object_type = 'document')
          AND d.del_status = 0
          AND d.doc_status = 1
          <if test="kbId != null">
            AND ol.kb_id = #{kbId}
          </if>
          <if test="userId != null">
            AND ol.created_by = #{userId}
          </if>
    </select>

    <!-- 最近预览文档列表（按最后一次预览时间倒序，去重文档） -->
    <select id="selectRecentViewed" resultType="com.serching.fulltextsearching.entity.KnowledgeDocument">
        SELECT d.*
        FROM t_operation_log ol
        JOIN t_knowledge_document d ON d.id = ol.object_id
        WHERE ol.operation_type = 4
          AND (ol.object_type IS NULL OR ol.object_type = 'document')
          AND d.del_status = 0
          AND d.doc_status = 1
          <if test="kbId != null">
            AND ol.kb_id = #{kbId}
          </if>
          <if test="userId != null">
            AND ol.created_by = #{userId}
          </if>
        GROUP BY d.id
        ORDER BY MAX(ol.created_at) DESC
        LIMIT #{pageNum}, #{pageSize}
    </select>

    <!-- 最近预览文档总数（去重） -->
    <select id="countRecentViewed" resultType="long">
        SELECT COUNT(DISTINCT ol.object_id)
        FROM t_operation_log ol
        JOIN t_knowledge_document d ON d.id = ol.object_id
        WHERE ol.operation_type = 4
          AND (ol.object_type IS NULL OR ol.object_type = 'document')
          AND d.del_status = 0
          AND d.doc_status = 1
          <if test="kbId != null">
            AND ol.kb_id = #{kbId}
          </if>
          <if test="userId != null">
            AND ol.created_by = #{userId}
          </if>
    </select>

</mapper>
