# 回收站功能实现说明

## 功能概述

回收站功能允许用户将文档移动到回收站而不是直接删除，提供了数据恢复的可能性。这是一个软删除的实现方案。

## 核心特性

1. **软删除**：文档不会从数据库中物理删除，而是通过 `del_status` 字段标记为已删除
2. **数据同步**：删除时同步清理 Dify 和 Elasticsearch 中的数据
3. **恢复功能**：可以从回收站恢复文档，并重新同步到相关服务
4. **权限控制**：基于用户ID进行权限验证

## 数据库设计

### 利用现有字段
- `t_knowledge_document.del_status`：
  - `0`：未删除（正常状态）
  - `1`：已删除（回收站状态）

### 查询过滤
- 正常文档列表：`del_status = 0`
- 回收站列表：`del_status = 1`

## API 接口

### 1. 移动文档到回收站
```
POST /api/recycle-bin/move/{documentId}?userId={userId}
```

**参数：**
- `documentId`：文档ID（路径参数）
- `userId`：操作用户ID（查询参数）

**功能：**
- 检查文档是否存在
- 验证文档是否已在回收站
- 同步删除 Dify 中的文档
- 删除 Elasticsearch 中的索引
- 更新数据库状态为已删除

### 2. 从回收站恢复文档
```
POST /api/recycle-bin/restore/{documentId}?userId={userId}
```

**参数：**
- `documentId`：文档ID（路径参数）
- `userId`：操作用户ID（查询参数）

**功能：**
- 检查文档是否在回收站中
- 重新同步到 Dify
- 重新建立 Elasticsearch 索引
- 更新数据库状态为正常

### 3. 获取回收站列表
```
GET /api/recycle-bin/list?kbId={kbId}&page={page}&size={size}
```

**参数：**
- `kbId`：知识库ID（必需）
- `page`：页码（默认1）
- `size`：每页大小（默认10）

**返回：**
- 分页的回收站文档列表
- 按更新时间倒序排列

### 4. 测试接口
```
GET /api/recycle-bin/test
```

**功能：**
- 返回回收站功能的说明信息

## 业务逻辑

### 删除到回收站流程
1. 验证文档存在性和状态
2. 同步删除 Dify 文档
3. 删除 Elasticsearch 索引
4. 更新数据库状态
5. 记录操作日志

### 恢复文档流程
1. 验证文档在回收站中
2. 重新上传到 Dify
3. 重新建立 Elasticsearch 索引
4. 更新数据库状态
5. 记录操作日志

## 数据同步策略

### Dify 同步
- **删除时**：调用 Dify API 删除文档
- **恢复时**：重新上传文件到 Dify

### Elasticsearch 同步
- **删除时**：删除文档索引
- **恢复时**：重新建立文档索引

### 文件处理
- **删除时**：保留本地文件（便于恢复）
- **恢复时**：使用原有文件

## 错误处理

### 异常情况
1. **文档不存在**：返回 404 错误
2. **文档状态异常**：返回 400 错误
3. **同步失败**：记录日志但不中断操作
4. **数据库操作失败**：抛出业务异常

### 事务管理
- 使用 `@Transactional` 确保数据一致性
- 外部服务同步失败不影响主流程

## 使用示例

### 移动文档到回收站
```bash
curl -X POST "http://localhost:8080/api/recycle-bin/move/123?userId=1"
```

### 恢复文档
```bash
curl -X POST "http://localhost:8080/api/recycle-bin/restore/123?userId=1"
```

### 获取回收站列表
```bash
curl -X GET "http://localhost:8080/api/recycle-bin/list?kbId=1&page=1&size=10"
```

## 注意事项

1. **权限验证**：当前版本需要传入 userId，后续可集成用户认证系统
2. **数据一致性**：外部服务同步失败时，主流程仍会继续执行
3. **性能考虑**：大量文档操作时需要考虑性能优化
4. **存储空间**：回收站中的文档仍占用存储空间，需要定期清理

## 后续扩展

1. **批量操作**：支持批量移动、恢复、删除
2. **自动清理**：定时清理过期文档
3. **权限细化**：基于角色的权限控制
4. **操作日志**：详细的操作记录和审计
5. **搜索功能**：在回收站中搜索文档
