## 数据库表设计（开发文档版）

本文档基于现有 SQL 建表语句，整理为面向开发的结构化说明，便于查询与对齐。包含每张表的用途、主键、字段说明、外键与建议索引。

### 全局约定
- 时间字段：`created_at`、`updated_at` 为 DATETIME，表示创建与更新时间。
- 操作人字段：`created_by`、`updated_by` 为 BIGINT，记录操作者用户 ID。
- 若未显式 NOT NULL，均视为可空（允许 NULL）。
- 所有表主键均为自增整型 `id`。

---

## 1. t_knowledge_base（知识库表）
- **用途**：知识库基本信息与权限控制。
- **主键**：`id (BIGINT)`

| 字段 | 类型 | 允许空 | 默认值 | 说明 |
|---|---|---|---|---|
| id | BIGINT | 否 | - | 主键，自增 |
| cover_image_path | VARCHAR(255) | 是 | - | 封面图片路径 |
| scope_type | SMALLINT | 是 | - | 权限可见范围：0 私密、1 公开 |
| description_info | TEXT | 是 | - | 知识库描述信息 |
| kb_type | SMALLINT | 是 | - | 知识库类型：0 默认、1 同步外部 |
| indexing_type | SMALLINT | 是 | - | 索引类型（业务自定义） |
| created_by | BIGINT | 是 | - | 创建人 |
| created_at | DATETIME | 是 | - | 创建时间 |
| updated_by | BIGINT | 是 | - | 更新人 |
| updated_at | DATETIME | 是 | - | 更新时间 |
| owner | VARCHAR(255) | 是 | - | 归属（组织/小组/外部关联 id） |
| permission | INT | 是 | - | 成员内容权限：0 可查看、1 可编辑 |
| tenant_id | BIGINT | 是 | - | 租户 id |

- **外键关系（逻辑）**：被多个表通过 `kb_id` 引用。
- **建议索引**：根据查询需要，可在 `tenant_id`、`owner`、`scope_type` 上建立组合或单列索引。

---

## 2. t_konwledge_base_outer_mapping（知识库外部系统关联）
注意：表名中 "konwledge" 存在拼写问题，文档沿用现状。

- **用途**：记录知识库与外部系统（如 dify、ragflow）的映射关系与配置。
- **主键**：`id (INT)`

| 字段 | 类型 | 允许空 | 默认值 | 说明 |
|---|---|---|---|---|
| id | INT | 否 | - | 主键，自增 |
| kb_id | BIGINT | 是 | - | 关联的知识库 id |
| out_id | VARCHAR(255) | 是 | - | 外部关联对象 id |
| out_type | VARCHAR(255) | 是 | - | 外部系统类型（如 dify、ragflow） |
| extended_info | TEXT | 是 | - | 外部额外配置信息（JSON 建议） |
| created_by | BIGINT | 是 | - | 创建人 |
| created_at | DATETIME | 是 | - | 创建时间 |
| updated_by | BIGINT | 是 | - | 更新人 |
| updated_at | DATETIME | 是 | - | 更新时间 |

- **外键关系（逻辑）**：`kb_id` → `t_knowledge_base.id`
- **建议索引**：`kb_id`、`out_type`、`out_id`

---

## 3. t_knowledge_base_member（知识库成员）
- **用途**：知识库成员与角色权限。
- **主键**：`id (INT)`

| 字段 | 类型 | 允许空 | 默认值 | 说明 |
|---|---|---|---|---|
| id | INT | 否 | - | 主键，自增 |
| kb_id | BIGINT | 是 | - | 知识库 id |
| user_id | BIGINT | 是 | - | 用户 id |
| member_type | SMALLINT | 是 | - | 成员类型：0 所有者(可管理)、1 管理员(可编辑)、3 普通成员(仅查看) |
| created_by | BIGINT | 是 | - | 创建人 |
| created_at | DATETIME | 是 | - | 创建时间 |
| updated_by | BIGINT | 是 | - | 更新人 |
| updated_at | DATETIME | 是 | - | 更新时间 |

- **外键关系（逻辑）**：`kb_id` → `t_knowledge_base.id`
- **建议索引**：`kb_id`、`user_id`、`(kb_id, user_id)` 唯一约束（若业务要求成员不重复）。

---

## 4. t_knowledge_base_category（知识库内分类/分组）
- **用途**：知识库内的分类信息。
- **主键**：`id (BIGINT)`

| 字段 | 类型 | 允许空 | 默认值 | 说明 |
|---|---|---|---|---|
| id | BIGINT | 否 | - | 主键，自增 |
| name | VARCHAR(255) | 是 | - | 分类名称 |
| kb_id | BIGINT | 是 | - | 所属知识库 id |
| created_by | BIGINT | 是 | - | 创建人 |
| created_at | DATETIME | 是 | - | 创建时间 |
| updated_by | BIGINT | 是 | - | 更新人 |
| updated_at | DATETIME | 是 | - | 更新时间 |

- **外键关系（逻辑）**：`kb_id` → `t_knowledge_base.id`
- **建议索引**：`kb_id`、`name`

---

## 5. t_knowledge_document（知识文档）
- **用途**：知识库内的文档内容与属性。
- **主键**：`id (INT)`

| 字段 | 类型 | 允许空 | 默认值 | 说明                             |
|---|---|-----|---|--------------------------------|
| id | INT | 否   | - | 主键，自增                          |
| kb_id | BIGINT | 是   | - | 关联知识库 id                       |
| category_id | BIGINT | 是   | - | 文档分类 id（可空表示未分组）               |
| title | VARCHAR(255) | 是   | - | 标题                             |
| summary | VARCHAR(255) | 是   | - | 概述描述                           |
| content | TEXT | 是   | - | 正文内容（Markdown 格式）              |
| word_count | INT | 是   | - | 字数                             |
| processing_status | SMALLINT | 是   | - | 处理状态：0 未开始、1 完成、2 处理中          |
| doc_status | SMALLINT | 是   | - | 文档状态：0 不可用、1 可用                |
| del_status | SMALLINT | 是   | - | 删除状态：0 未删除、1 已删除               |
| doc_type | INT | 是   | - | 文档类型：0 文本、1 图片、2 音频、3 视频、4 其他  |
| doc_suffix | VARCHAR(255) | 是   | - | 文件后缀                           |
| doc_metadata | TEXT | 是   | - | 文档其他信息（建议 JSON）                |
| file_id | BIGINT | 是   | - | 关联文件 id（`t_knowledge_file.id`） |
| preview_info | VARCHAR(255) | 是   | - | 预览信息 / 地址                      |
| created_by | BIGINT | 是   | - | 创建人                            |
| created_at | DATETIME | 是   | - | 创建时间                           |
| updated_by | BIGINT | 是   | - | 更新人                            |
| updated_at | DATETIME | 是   | - | 更新时间                           |
| dify_document_id | varchar(255) | 是   | - | dify中知识库id                     |
- **外键关系（逻辑）**：
  - `kb_id` → `t_knowledge_base.id`
  - `category_id` → `t_knowledge_base_category.id`
  - `file_id` → `t_knowledge_file.id`
- **建议索引**：`kb_id`、`category_id`、`doc_status`、`del_status`

---

## 6. t_knowledge_document_segment（文档片段/切片）
- **用途**：存储文档的切片内容，用于检索或向量化等。
- **主键**：`id (INT)`

| 字段 | 类型 | 允许空 | 默认值 | 说明 |
|---|---|---|---|---|
| id | INT | 否 | - | 主键，自增 |
| kb_id | BIGINT | 是 | - | 知识库 id（冗余便于按库检索） |
| doc_id | BIGINT | 是 | - | 文档 id |
| content | TEXT | 是 | - | 文档切片内容 |
| created_by | BIGINT | 是 | - | 创建人 |
| created_at | DATETIME | 是 | - | 创建时间 |
| updated_by | BIGINT | 是 | - | 更新人 |
| updated_at | DATETIME | 是 | - | 更新时间 |

- **外键关系（逻辑）**：
  - `kb_id` → `t_knowledge_base.id`
  - `doc_id` → `t_knowledge_document.id`
- **建议索引**：`doc_id`、`kb_id`

---

## 7. t_operation_log（操作日志）
- **用途**：记录业务操作行为。
- **主键**：`id (INT)`

| 字段 | 类型 | 允许空 | 默认值 | 说明 |
|---|---|---|---|---|
| id | INT | 否 | - | 主键，自增 |
| title | VARCHAR(255) | 是 | - | 操作描述 |
| operation_type | SMALLINT | 是 | - | 操作类型（业务自定义） |
| object_id | SMALLINT | 是 | - | 操作对象 id（如知识库 id、文档 id） |
| object_type | VARCHAR(255) | 是 | - | 对象类型（知识库/知识/成员等） |
| created_by | BIGINT | 是 | - | 创建人 |
| created_at | DATETIME | 是 | - | 创建时间 |
| updated_by | BIGINT | 是 | - | 更新人 |
| updated_at | DATETIME | 是 | - | 更新时间 |

- **建议索引**：`object_type`、`object_id`、`created_at`

---

## 8. t_knowledge_file（文件信息）
- **用途**：存储上传文件元信息。
- **主键**：`id (INT)`

| 字段 | 类型 | 允许空 | 默认值 | 说明 |
|---|---|---|---|---|
| id | INT | 否 | - | 主键，自增 |
| name | VARCHAR(255) | 是 | - | 文件名 |
| file_path | VARCHAR(255) | 是 | - | 存储路径 |
| suffix | VARCHAR(255) | 是 | - | 后缀名 |
| file_szie | INT | 是 | - | 文件大小（注意：字段名存在拼写问题，现状为 file_szie） |
| md5 | VARCHAR(255) | 是 | - | 文件 MD5 值 |
| encryption | SMALLINT | 是 | - | 是否加密：0 否、1 是（建议） |
| created_by | BIGINT | 是 | - | 创建人 |
| created_at | DATETIME | 是 | - | 创建时间 |
| updated_by | BIGINT | 是 | - | 更新人 |
| updated_at | DATETIME | 是 | - | 更新时间 |

- **被引用**：`t_knowledge_document.file_id`
- **建议索引**：`md5`（用于去重）、`created_at`

---

## 关系概览
- `t_knowledge_base` 作为核心表，被以下表通过 `kb_id` 关联：
  - `t_konwledge_base_outer_mapping`、`t_knowledge_base_member`、`t_knowledge_base_category`、`t_knowledge_document`、`t_knowledge_document_segment`
- 文档与分类：`t_knowledge_document.category_id` → `t_knowledge_base_category.id`
- 文档与文件：`t_knowledge_document.file_id` → `t_knowledge_file.id`
- 切片与文档：`t_knowledge_document_segment.doc_id` → `t_knowledge_document.id`

> 说明：以上为现有表结构的“文档化”描述，不改变数据库实际定义；若需修正拼写或新增索引/约束，请在评审通过后再行变更。
